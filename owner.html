<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>326臭臭鍋 訂單管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
  <style>
    .card{border-radius:1rem}.btn{border-radius:1rem}.container-slim{max-width:1200px}.mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

<script>
// 簡易 PIN（前端可見，僅防誤入）
const OWNER_PIN = "326";
const input = prompt("請輸入管理 PIN");
if (input !== OWNER_PIN) { alert("PIN 錯誤"); location.href = "index.html"; }
</script>

<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="mx-auto container-slim px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-slate-900 text-white rounded-xl grid place-items-center text-lg font-bold select-none">管</div>
      <div>
        <div class="text-xl font-semibold">326臭臭鍋 訂單管理</div>
        <div class="text-xs text-slate-500">16:30–20:30 ・ 每 15 分鐘上限 7 鍋</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <input id="datePicker" type="date" class="px-3 py-2 border border-slate-300 rounded-lg">
      <button id="toggleAll" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">顯示全部</button>
      <button id="exportCsv" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">匯出 CSV</button>
      <button id="clearToday" class="btn px-3 py-2 bg-red-600 text-white hover:bg-red-700">清空今日</button>
    </div>
  </div>
</header>

<main class="mx-auto container-slim px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <section class="lg:col-span-1">
    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-2">時段佔用</h2>
      <div id="slotSummary" class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm"></div>
    </div>
    <div class="card bg-white p-5 mt-6">
      <h2 class="text-lg font-semibold mb-2">統計</h2>
      <div class="flex items-center justify-between py-1"><div class="text-slate-600">訂單數</div><div id="statOrders" class="mono font-semibold">0</div></div>
      <div class="flex items-center justify-between py-1"><div class="text-slate-600">總鍋數（等效）</div><div id="statCapacity" class="mono font-semibold">0</div></div>
      <div class="flex items-center justify-between py-1"><div class="text-slate-600">營業額</div><div id="statRevenue" class="mono font-semibold">$0</div></div>
    </div>
  </section>

  <section class="lg:col-span-2">
    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">訂單列表</h2>
      <div class="overflow-auto">
        <table class="w-full text-sm border border-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th class="p-2 border-b text-left">時間</th>
              <th class="p-2 border-b text-left">姓名</th>
              <th class="p-2 border-b text-left">電話</th>
              <th class="p-2 border-b text-left">品項</th>
              <th class="p-2 border-b text-right">鍋數</th>
              <th class="p-2 border-b text-right">金額</th>
              <th class="p-2 border-b text-right">操作</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<footer class="border-t border-slate-200 mt-12">
  <div class="mx-auto container-slim px-4 py-6 text-sm text-slate-600">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>© <span id="year"></span> 326臭臭鍋</div>
      <div class="text-slate-500">資料儲存於 Google Sheet（Apps Script）</div>
    </div>
  </div>
</footer>

<script>
/* ===== API 端點與 Key ===== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbycF73j0CR5HEpe4Rm5Zn1tQU9LS0Yq2dLlNmsXax2pd2C05DUGv1ZPlbksa7csCp5rsw/exec';
const API_KEY  = '326hotpot326';

/* ===== 共用工具與設定 ===== */
const STORE = { openHour:16, openMinute:30, closeHour:20, closeMinute:30, slotMinutes:15, slotCapacity:7 };
const el = s => document.querySelector(s);
let showAll = false;
let currentList = [];

function pad2(n){return n.toString().padStart(2,"0")}
function formatCurrency(n){return " $" + n.toLocaleString("zh-Hant")}
function todayIsoDate(){const d=new Date();return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`}
function dateAtTime(dateStr,hh,mm){const d=new Date(dateStr+"T00:00:00");d.setHours(hh,mm,0,0);return d;}
function slotKey(d){return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`}
function generateSlotsForDate(dateStr){
  const start=dateAtTime(dateStr,STORE.openHour,STORE.openMinute);
  const end=dateAtTime(dateStr,STORE.closeHour,STORE.closeMinute);
  const step=STORE.slotMinutes*60*1000, arr=[];
  for(let t=start.getTime(); t<end.getTime(); t+=step){ arr.push(new Date(t)) }
  return arr;
}

async function apiList(dateStr){
  const url = new URL(ENDPOINT);
  url.searchParams.set('action','list');
  if (dateStr) url.searchParams.set('date', dateStr);
  url.searchParams.set('key', API_KEY);
  const res = await fetch(url.toString(), { method:'GET' });
  const json = await res.json();
  if (!json.ok) throw new Error('list_failed');
  return (json.orders||[]).sort((a,b)=>new Date(a.assignedSlot)-new Date(b.assignedSlot));
}
async function apiDelete(id){
  const res = await fetch(ENDPOINT, {
    method:'POST',
    body: JSON.stringify({ apiKey: API_KEY, action:'delete', id })
  });
  const json = await res.json();
  if (!json.ok) throw new Error('delete_failed');
  return json;
}

function slotUsageMap(dateStr, list){
  const map={}; for(const o of list.filter(x=>x.date===dateStr)){ const k=slotKey(new Date(o.assignedSlot)); map[k]=(map[k]||0)+o.capacityUnits } return map;
}

function render(dateStr){
  const list = showAll ? currentList : currentList.filter(o=>o.date===dateStr);
  // 時段佔用
  const m=slotUsageMap(dateStr, list), sum=el("#slotSummary"); sum.innerHTML="";
  for(const s of generateSlotsForDate(dateStr)){
    const k=slotKey(s), used=m[k]||0;
    const div=document.createElement("div");
    div.className="border border-slate-200 rounded-xl p-2";
    div.innerHTML=`
      <div class="text-xs text-slate-600">${k}</div>
      <div class="font-semibold mono">${used} / ${STORE.slotCapacity}</div>
      <div class="h-2 bg-slate-100 rounded mt-1"><div class="h-2 bg-slate-900 rounded" style="width:${Math.min(100, used/STORE.slotCapacity*100)}%"></div></div>`;
    sum.appendChild(div);
  }
  // 訂單表
  const tbody=el("#ordersBody"); tbody.innerHTML="";
  let totalCap=0, revenue=0;
  for(const o of list){
    totalCap+=o.capacityUnits; revenue+=o.total;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="p-2 border-b">${slotKey(new Date(o.assignedSlot))}</td>
      <td class="p-2 border-b">${o.customer?.name||""}</td>
      <td class="p-2 border-b">${o.customer?.phone||""}</td>
      <td class="p-2 border-b">${o.items.map(it=>`${it.name}×${it.qty}`).join("，")}</td>
      <td class="p-2 border-b text-right mono">${o.capacityUnits}</td>
      <td class="p-2 border-b text-right mono">${formatCurrency(o.total)}</td>
      <td class="p-2 border-b text-right">
        <button data-id="${o.id}" class="del btn px-2 py-1 border border-slate-300 hover:bg-slate-100">刪除</button>
      </td>`;
    tbody.appendChild(tr);
  }
  el("#statOrders").textContent=String(list.length);
  el("#statCapacity").textContent=String(totalCap);
  el("#statRevenue").textContent=formatCurrency(revenue);
  tbody.querySelectorAll(".del").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      if (!confirm("確定刪除這張訂單？")) return;
      await apiDelete(btn.getAttribute("data-id"));
      await reloadAndRender();
    });
  });
}

async function reloadAndRender(){
  const dateStr = el("#datePicker").value || todayIsoDate();
  currentList = await apiList(showAll ? '' : dateStr);
  render(dateStr);
}

function exportCsv(){
  const dateStr = el("#datePicker").value || todayIsoDate();
  const list = showAll ? currentList : currentList.filter(o=>o.date === dateStr);
  const rows=[["訂單ID","日期","時段","姓名","電話","品項","火鍋等效","小計","折扣","總計","建立時間"]];
  for(const o of list){
    rows.push([
      o.id,o.date,slotKey(new Date(o.assignedSlot)),
      o.customer?.name||"",o.customer?.phone||"",
      o.items.map(it=>`${it.name}×${it.qty}`).join(" / "),
      o.capacityUnits,o.subtotal,o.discount,o.total,o.createdAt
    ]);
  }
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=`orders_${Date.now()}.csv`; a.click();
  URL.revokeObjectURL(url);
}

document.addEventListener("DOMContentLoaded", async ()=>{
  el("#year").textContent=new Date().getFullYear();
  const dp = el("#datePicker"); dp.value = todayIsoDate();
  el("#toggleAll").addEventListener("click", async ()=>{
    showAll = !showAll;
    el("#toggleAll").textContent = showAll ? '只看今天' : '顯示全部';
    await reloadAndRender();
  });
  el("#exportCsv").addEventListener("click", exportCsv);
  el("#clearToday").addEventListener("click", async ()=>{
    if(!confirm("清空今日所有訂單？此動作無法還原。")) return;
    const today = todayIsoDate();
    const todayList = currentList.filter(o=>o.date===today);
    for (const o of todayList) { await apiDelete(o.id); }
    await reloadAndRender();
  });
  dp.addEventListener("change", reloadAndRender);

  await reloadAndRender();
  setInterval(reloadAndRender, 2000);
});
</script>
</body>
</html>
