<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>326臭臭鍋 線上點餐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
  <style>
    .card{border-radius:1rem}.btn{border-radius:1rem}.badge{border-radius:999px}
    .container-slim{max-width:1200px}.mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="mx-auto container-slim px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-slate-900 text-white rounded-xl grid place-items-center text-lg font-bold select-none">店</div>
      <div>
        <div class="text-xl font-semibold">326臭臭鍋 線上點餐</div>
        <div class="text-xs text-slate-500">營業時間 16:30–20:30 ・ 每 15 分鐘上限 7 鍋</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <a href="#cart" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">購物車</a>
    </div>
  </div>
</header>

<main class="mx-auto container-slim px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <section class="lg:col-span-2 space-y-6">
    <div class="card bg-white p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">搜尋商品</label>
          <input id="searchInput" type="text" placeholder="輸入關鍵字"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900" />
        </div>
        <div>
          <label class="text-sm text-slate-600">標籤</label>
          <select id="tagSelect" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"><option value="">全部</option></select>
        </div>
      </div>
    </div>
    <div id="menuList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
  </section>

  <aside id="cart" class="space-y-6">
    <div class="card bg-white p-5 sticky top-[88px]">
      <h2 class="text-lg font-semibold mb-4">購物車</h2>
      <div id="cartItems" class="space-y-3"></div>
      <div class="border-t pt-4 mt-4 flex items-center justify-between">
        <div class="text-slate-600">小計</div>
        <div id="cartSubtotal" class="font-semibold mono">$0</div>
      </div>
      <div class="flex items-center justify-between">
        <div class="text-slate-600">預估折扣</div>
        <div id="cartDiscount" class="mono">-$0</div>
      </div>
      <div class="flex items-center justify-between text-lg font-semibold">
        <div>總計</div>
        <div id="cartTotal" class="mono">$0</div>
      </div>
      <button id="clearCart" class="mt-3 w-full btn px-4 py-2 border border-slate-300 hover:bg-slate-100">清空購物車</button>
    </div>

    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">取餐資訊</h2>
      <form id="checkoutForm" class="space-y-4" autocomplete="off">
        <div>
          <label class="text-sm text-slate-600">姓名</label>
          <input required id="customerName" type="text" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600">電話</label>
          <input required id="customerPhone" type="tel" pattern="[0-9\\-\\+\\s]{8,}" placeholder="09xx-xxx-xxx"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600">最早可取餐時間（選填）</label>
          <select id="earliestTime" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
            <option value="">不指定（系統自動安排）</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">未選時，系統會從「現在 + 準備緩衝」開始排。</p>
        </div>
        <div class="bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm">
          每 15 分鐘一個時段；每時段上限 7 鍋（火鍋等效單位）
        </div>
        <button type="submit" class="w-full btn px-4 py-3 bg-slate-900 text-white hover:bg-slate-800">送出訂單</button>
        <p id="formError" class="text-sm text-red-600"></p>
      </form>
    </div>
  </aside>
</main>

<div id="successModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 mx-auto mt-24 w-[92%] max-w-xl card bg-white p-6">
    <h3 class="text-xl font-semibold mb-2">下單成功</h3>
    <p class="text-slate-700">您的取餐時段為：</p>
    <p id="assignedSlotText" class="text-2xl font-bold mt-1"></p>
    <div class="mt-4 flex justify-end">
      <button id="closeSuccess" class="btn px-4 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
    </div>
  </div>
</div>

<footer class="border-t border-slate-200 mt-12">
  <div class="mx-auto container-slim px-4 py-6 text-sm text-slate-600">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>營業時間：每日 16:30–20:30</div>
      <div>© <span id="year"></span> 326臭臭鍋</div>
    </div>
  </div>
</footer>

<script>
/* ===== API 端點與 Key（部署後必填） ===== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbze9Zp_vmiZTwF_o-3WO6lY-oqo5aKGrc2Ow58s4DZOhXmHQwDptXvNoACdHTb9LMP3eA/exec'; // ← 換成你的 Web App URL
const API_KEY  = '326hotpot326'; // ← 與後端一致

/* ===== 設定 ===== */
const STORE = {
  name: "326臭臭鍋",
  openHour: 16, openMinute: 30,
  closeHour: 20, closeMinute: 30,
  slotMinutes: 15,
  slotCapacity: 7,
  prepBufferMinutes: 20,
  discountThreshold: 1500,
  discountAmount: 100,
};

/* ===== 菜單（含辣度） ===== */
const SPICE = ["無辣","小辣","中辣","大辣"];
const MENU = [
  { id:"臭臭鍋", name:"臭臭鍋", price:100, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"鴨血鍋", name:"鴨血鍋", price:90, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"泡菜鍋", name:"泡菜鍋", price:110, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE.filter(s=>s!=="無辣") },
  { id:"什錦鍋", name:"什錦鍋", price:130, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"腸旺鍋", name:"腸旺鍋", price:130, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"牛雜鍋", name:"牛雜鍋", price:150, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"大腸鴨血鍋", name:"大腸鴨血鍋", price:140, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"白飯", name:"白飯", price:10, tags:["主食"], capacityUnits:0 },
  { id:"冬粉", name:"冬粉", price:10, tags:["主食"], capacityUnits:0 },
  { id:"科學麵", name:"科學麵", price:15, tags:["主食"], capacityUnits:0 },
  { id:"蟹肉棒", name:"蟹肉棒", price:20, tags:["單點"], capacityUnits:0 },
  { id:"鱈魚丸", name:"鱈魚丸", price:20, tags:["單點"], capacityUnits:0 },
  { id:"北海翅", name:"北海翅", price:20, tags:["單點"], capacityUnits:0 },
  { id:"鑫鑫腸", name:"鑫鑫腸", price:20, tags:["單點"], capacityUnits:0 },
  { id:"高麗菜(冬)", name:"高麗菜(冬)", price:20, tags:["單點"], capacityUnits:0 },
  { id:"金針菇", name:"金針菇", price:10, tags:["單點"], capacityUnits:0 },
  { id:"臭豆腐", name:"臭豆腐", price:20, tags:["單點"], capacityUnits:0 },
  { id:"貢丸", name:"貢丸", price:20, tags:["單點"], capacityUnits:0 },
  { id:"魚餃", name:"魚餃", price:20, tags:["單點"], capacityUnits:0 },
  { id:"燕餃", name:"燕餃", price:20, tags:["單點"], capacityUnits:0 },
  { id:"黑輪", name:"黑輪", price:20, tags:["單點"], capacityUnits:0 },
  { id:"米血", name:"米血", price:20, tags:["單點"], capacityUnits:0 },
  { id:"鴨血", name:"鴨血", price:20, tags:["單點"], capacityUnits:0 },
  { id:"蝦球", name:"蝦球", price:20, tags:["單點"], capacityUnits:0 },
  { id:"大腸", name:"大腸", price:50, tags:["單點"], capacityUnits:0 },
  { id:"豆皮", name:"豆皮", price:30, tags:["單點"], capacityUnits:0 },
];

/* ===== 狀態 & 工具 ===== */
const el = s => document.querySelector(s);
const state = { cart:{}, filter:{keyword:"",tag:""}, ordersCache:[] };

function pad2(n){return n.toString().padStart(2,"0")}
function formatCurrency(n){return " $" + n.toLocaleString("zh-Hant")}
function todayIsoDate(){const d=new Date();return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`}
function dateAtTime(dateStr,hh,mm){const d=new Date(dateStr+"T00:00:00");d.setHours(hh,mm,0,0);return d;}
function roundUpToSlot(d, minutes){const ms=minutes*60*1000;return new Date(Math.ceil(d.getTime()/ms)*ms)}
function slotKey(d){return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`}
function generateSlotsForDate(dateStr){
  const start=dateAtTime(dateStr,STORE.openHour,STORE.openMinute);
  const end=dateAtTime(dateStr,STORE.closeHour,STORE.closeMinute);
  const step=STORE.slotMinutes*60*1000, arr=[];
  for(let t=start.getTime(); t<end.getTime(); t+=step){ arr.push(new Date(t)) }
  return arr;
}

async function apiList(dateStr){
  const url = new URL(ENDPOINT);
  url.searchParams.set('action','list');
  if (dateStr) url.searchParams.set('date', dateStr);
  url.searchParams.set('key', API_KEY); // 傳 key（簡易）
  const res = await fetch(url.toString(), { method:'GET' });
  const json = await res.json();
  if (!json.ok) throw new Error('list failed');
  return json.orders || [];
}
async function apiCreate(order){
  const res = await fetch(ENDPOINT, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ apiKey: API_KEY, action:'create', order })
  });
  const json = await res.json();
  if (!json.ok) throw new Error('create failed');
  return json;
}

function bookedCapacityMap(dateStr){
  const map={};
  for(const o of state.ordersCache.filter(o=>o.date===dateStr)){
    const k = slotKey(new Date(o.assignedSlot));
    map[k] = (map[k]||0) + (o.capacityUnits||0);
  }
  return map;
}
function itemsCapacityUnitsFromCart(){
  return Object.values(state.cart).reduce((s,r)=>s+r.item.capacityUnits*r.qty,0);
}
function itemsPriceFromCart(){
  return Object.values(state.cart).reduce((s,r)=>s+r.item.price*r.qty,0);
}
function autoAssignSlot(dateStr, earliest){
  const booked=bookedCapacityMap(dateStr);
  for(const s of generateSlotsForDate(dateStr)){
    if(s.getTime()<earliest.getTime()) continue;
    const used = booked[slotKey(s)] || 0;
    if(used + itemsCapacityUnitsFromCart() <= STORE.slotCapacity) return s;
  }
  return null;
}

/* ===== UI：篩選與菜單 ===== */
function initFilters(){
  const uniq=Array.from(new Set(MENU.flatMap(m=>m.tags))).sort();
  const sel=el("#tagSelect"); uniq.forEach(t=>{const o=document.createElement("option");o.value=t;o.textContent=t;sel.appendChild(o)});
  el("#tagSelect").addEventListener("change",()=>{state.filter.tag=el("#tagSelect").value; renderMenu()});
  el("#searchInput").addEventListener("input",e=>{state.filter.keyword=e.target.value.trim(); renderMenu()});
}
function renderMenu(){
  const root=el("#menuList"); root.innerHTML="";
  const q=state.filter.keyword.toLowerCase(), tag=state.filter.tag;
  const list=MENU.filter(m=>{
    const hitQ=q ? (m.name.toLowerCase().includes(q)) : true;
    const hitT=tag ? m.tags.includes(tag) : true;
    return hitQ && hitT;
  });
  if(!list.length){ root.innerHTML=`<div class="text-slate-600">目前沒有符合的商品。</div>`; return; }

  for(const item of list){
    const card=document.createElement("div"); card.className="card bg-white p-4 flex flex-col";
    const spiceHtml = item.spice
      ? `<label class="text-sm text-slate-600 block mt-2">辣度</label>
         <select class="spice mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
           ${item.spiceOpts.map(s=>`<option value="${s}">${s}</option>`).join("")}
         </select>` : "";

    card.innerHTML=`
      <div class="flex-1">
        <div class="flex items-start justify-between gap-3">
          <h3 class="text-lg font-semibold">${item.name}</h3>
          <div class="text-right font-semibold mono">${formatCurrency(item.price)}</div>
        </div>
        <div class="mt-2 flex flex-wrap gap-1">
          ${item.tags.map(t=>`<span class="badge text-xs px-2 py-1 bg-slate-100 text-slate-700 border border-slate-200">${t}</span>`).join("")}
          ${item.capacityUnits>0?`<span class="badge text-xs px-2 py-1 bg-amber-50 text-amber-700 border border-amber-200">火鍋等效 1</span>`:""}
        </div>
        ${spiceHtml}
      </div>
      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-slate-600">加入購物車數量</div>
        <div class="flex items-center gap-2">
          <button class="dec btn px-3 py-2 border border-slate-300 hover:bg-slate-100">-</button>
          <input type="number" min="1" value="1" class="qty w-16 text-center border border-slate-300 rounded-xl py-2" />
          <button class="inc btn px-3 py-2 border border-slate-300 hover:bg-slate-100">+</button>
          <button class="add btn px-3 py-2 bg-slate-900 text-white hover:bg-slate-800">加入</button>
        </div>
      </div>`;

    const qty=card.querySelector(".qty");
    card.querySelector(".dec").addEventListener("click",()=>{qty.value=Math.max(1,parseInt(qty.value||"1")-1)});
    card.querySelector(".inc").addEventListener("click",()=>{qty.value=Math.max(1,parseInt(qty.value||"1")+1)});
    card.querySelector(".add").addEventListener("click",()=>{
      const chosenSpice = item.spice ? card.querySelector(".spice").value : null;
      addToCart(item, parseInt(qty.value||"1",10), chosenSpice);
    });
    root.appendChild(card);
  }
}

/* ===== 購物車 ===== */
function addToCart(item, qty, spice=null){
  const key = spice ? `${item.id}:${spice}` : item.id;
  const displayName = spice ? `${item.name}（${spice}）` : item.name;
  if(!state.cart[key]) state.cart[key]={ item:{...item, name:displayName}, qty };
  else state.cart[key].qty += qty;
  renderCart();
}
function renderCart(){
  const root=el("#cartItems"); root.innerHTML="";
  const entries=Object.values(state.cart);
  if(!entries.length){ root.innerHTML=`<div class="text-slate-500">購物車目前沒有商品。</div>`; }
  else{
    for(const row of entries){
      const price=row.item.price*row.qty;
      const div=document.createElement("div");
      div.className="flex items-center justify-between gap-3";
      div.innerHTML=`
        <div class="min-w-0">
          <div class="font-medium truncate">${row.item.name}</div>
          <div class="text-sm text-slate-600">
            單價 ${formatCurrency(row.item.price)} ×
            <input type="number" min="1" value="${row.qty}" class="lineQty w-16 text-center border border-slate-300 rounded-lg py-1 mx-1">
            = <span class="mono">${formatCurrency(price)}</span>
          </div>
        </div>
        <button class="remove btn px-3 py-2 border border-slate-300 hover:bg-slate-100">移除</button>`;
      div.querySelector(".lineQty").addEventListener("input",e=>{row.qty=Math.max(1,parseInt(e.target.value||"1")); renderCart()});
      div.querySelector(".remove").addEventListener("click",()=>{ for(const k in state.cart){ if(state.cart[k]===row){ delete state.cart[k]; break; } } renderCart();});
      root.appendChild(div);
    }
  }
  const subtotal=itemsPriceFromCart();
  const discount=subtotal>=STORE.discountThreshold?STORE.discountAmount:0;
  el("#cartSubtotal").textContent=formatCurrency(subtotal);
  el("#cartDiscount").textContent="-"+formatCurrency(discount).slice(1);
  el("#cartTotal").textContent=formatCurrency(Math.max(0,subtotal-discount));
}

/* ===== 下單流程（改用後端） ===== */
function populateEarliestTimeOptions(){
  const dateStr=todayIsoDate(), sel=el("#earliestTime");
  for(const s of generateSlotsForDate(dateStr)){
    const label=slotKey(s), opt=document.createElement("option");
    opt.value=label; opt.textContent=label; sel.appendChild(opt);
  }
}

async function refreshTodayOrders(){
  const dateStr=todayIsoDate();
  state.ordersCache = await apiList(dateStr);
}

async function onSubmitOrder(e){
  e.preventDefault(); el("#formError").textContent="";
  if(!Object.values(state.cart).length){ el("#formError").textContent="購物車尚無商品。"; return; }
  const name=el("#customerName").value.trim(), phone=el("#customerPhone").value.trim();
  if(!name || !phone){ el("#formError").textContent="請完整填寫姓名與電話。"; return; }

  const dateStr=todayIsoDate(); const now=new Date();
  const earliestSel=el("#earliestTime").value;
  let earliest = earliestSel
    ? dateAtTime(dateStr, parseInt(earliestSel.slice(0,2),10), parseInt(earliestSel.slice(3),10))
    : new Date(now.getTime() + STORE.prepBufferMinutes*60*1000);
  earliest = roundUpToSlot(earliest, STORE.slotMinutes);
  const openAt = dateAtTime(dateStr, STORE.openHour, STORE.openMinute);
  if(earliest.getTime()<openAt.getTime()) earliest=openAt;

  // 先抓最新訂單再分配，避免超賣
  await refreshTodayOrders();
  const slot = autoAssignSlot(dateStr, earliest);
  if(!slot){ el("#formError").textContent="今日可用時段已滿，請改天或稍後再試。"; return; }

  const items=Object.values(state.cart).map(r=>({
    id:r.item.id, name:r.item.name, price:r.item.price,
    qty:r.qty, capacityUnits:r.item.capacityUnits
  }));
  const capacityUnits=items.reduce((s,it)=>s+it.capacityUnits*it.qty,0);
  const subtotal=items.reduce((s,it)=>s+it.price*it.qty,0);
  const discount=subtotal>=STORE.discountThreshold?STORE.discountAmount:0;
  const total=Math.max(0, subtotal-discount);

  const order={
    id:"O"+Date.now(),
    date:dateStr,
    assignedSlot:slot.toISOString(),
    capacityUnits,
    customer:{name,phone},
    items, subtotal, discount, total,
    createdAt:new Date().toISOString(),
    source:"web-customer",
  };

  try{
    await apiCreate(order);
    state.cart={}; renderCart();
    el("#assignedSlotText").textContent=`${order.date} ${slotKey(new Date(order.assignedSlot))}`;
    el("#successModal").classList.remove("hidden");
  }catch(err){
    el("#formError").textContent="送單失敗，請稍後再試。";
  }
}

document.addEventListener("DOMContentLoaded", async ()=>{
  initFilters(); renderMenu(); renderCart(); populateEarliestTimeOptions();
  el("#year").textContent=new Date().getFullYear();
  el("#checkoutForm").addEventListener("submit", onSubmitOrder);
  el("#clearCart").addEventListener("click",()=>{state.cart={}; renderCart()});
  el("#closeSuccess").addEventListener("click",()=>el("#successModal").classList.add("hidden"));
  await refreshTodayOrders(); // 頁面載入先抓一次，讓占用條件更準
});
</script>
</body>
</html>
