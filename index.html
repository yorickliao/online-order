<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>326臭臭鍋 線上點餐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
  <style>
    .card{border-radius:1rem}.btn{border-radius:1rem}.badge{border-radius:999px}
    .container-slim{max-width:1200px}.mono{font-variant-numeric:tabular-nums}
  </style>

  <!-- 固定以台北時區計算與顯示 -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_utc);
    dayjs.extend(dayjs_plugin_timezone);
    const STORE_TZ = 'Asia/Taipei';
    dayjs.tz.setDefault(STORE_TZ);
  </script>
</head>
<body class="bg-slate-50 text-slate-900 selection:bg-slate-200 selection:text-slate-900">
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="mx-auto container-slim px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-slate-900 text-white rounded-xl grid place-items-center text-lg font-bold select-none">店</div>
      <div>
        <div class="text-xl font-semibold">326臭臭鍋 線上點餐</div>
        <div class="text-xs text-slate-500">營業時間 16:30–20:30 ・ 每 15 分鐘上限 7 鍋</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <a href="#cart" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">購物車</a>
    </div>
  </div>
</header>

<main class="mx-auto container-slim px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <section class="lg:col-span-2 space-y-6">
    <div class="card bg-white p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">搜尋商品</label>
          <input id="searchInput" type="text" placeholder="輸入關鍵字"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900" />
        </div>
        <div>
          <label class="text-sm text-slate-600">標籤</label>
          <select id="tagSelect" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"><option value="">全部</option></select>
        </div>
      </div>
    </div>
    <div id="menuList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
  </section>

  <aside id="cart" class="space-y-6">
    <div class="card bg-white p-5 sticky top-[88px]">
      <h2 class="text-lg font-semibold mb-4">購物車</h2>
      <div id="cartItems" class="space-y-3"></div>
      <div class="border-t pt-4 mt-4 flex items-center justify-between">
        <div class="text-slate-600">小計</div>
        <div id="cartSubtotal" class="font-semibold mono">$0</div>
      </div>
      <div class="flex items-center justify-between">
        <div class="text-slate-600">預估折扣</div>
        <div id="cartDiscount" class="mono">-$0</div>
      </div>
      <div class="flex items-center justify-between text-lg font-semibold">
        <div>總計</div>
        <div id="cartTotal" class="mono">$0</div>
      </div>
      <button id="clearCart" class="mt-3 w-full btn px-4 py-2 border border-slate-300 hover:bg-slate-100">清空購物車</button>
    </div>

    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">取餐資訊</h2>
      <form id="checkoutForm" class="space-y-4" autocomplete="off">
        <div>
          <label class="text-sm text-slate-600">姓名</label>
          <input required id="customerName" type="text" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600">電話</label>
          <input required id="customerPhone" type="tel" pattern="[0-9\\-\\+\\s]{8,}" placeholder="09xx-xxx-xxx"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
        </div>
        <div>
          <label class="text-sm text-slate-600">最早可取餐時間（選填）</label>
          <select id="earliestTime" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
            <option value="">不指定（系統自動安排）</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">未選時，系統會從「現在 + 準備緩衝」開始排；若已打烊，會自動排隔天第一個時段。</p>
        </div>
        <div class="bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm">
          每 15 分鐘一個時段；每時段上限 7 鍋（火鍋等效單位）
        </div>
        <button type="submit" class="w-full btn px-4 py-3 bg-slate-900 text-white hover:bg-slate-800">送出訂單</button>
        <p id="formError" class="text-sm text-red-600"></p>
      </form>
    </div>
  </aside>
</main>

<div id="successModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 mx-auto mt-24 w-[92%] max-w-xl card bg-white p-6">
    <h3 class="text-xl font-semibold mb-2">下單成功</h3>
    <p class="text-slate-700">您的取餐時段為：</p>
    <p id="assignedSlotText" class="text-2xl font-bold mt-1"></p>
    <p class="text-sm text-slate-600 mt-2">請準時取餐，現場可能會有 5–10 分鐘彈性。</p>
    <div class="mt-4 flex justify-end">
      <button id="closeSuccess" class="btn px-4 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
    </div>
  </div>
</div>

<footer class="border-t border-slate-200 mt-12">
  <div class="mx-auto container-slim px-4 py-6 text-sm text-slate-600">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>營業時間：每日 16:30–20:30</div>
      <div>© <span id="year"></span> 326臭臭鍋</div>
    </div>
  </div>
</footer>

<script>
/* ===== API 端點與 Key（最新部署） ===== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxvRLFEEufoN3dIwyBeTZp315vWdmxZYL4cqEubJf6Gcy7voEKw0UNbZ25q3_7KLTQERw/exec';
const API_KEY  = '326hotpot326';

/* ===== 店舖設定 ===== */
const STORE = {
  name: "326臭臭鍋",
  openHour: 16, openMinute: 30,
  closeHour: 20, closeMinute: 30,
  slotMinutes: 15,
  slotCapacity: 7,
  prepBufferMinutes: 20,
  discountThreshold: 1500,
  discountAmount: 100,
};

/* ===== 菜單（含辣度） ===== */
const SPICE = ["無辣","小辣","中辣","大辣"];
const MENU = [
  { id:"臭臭鍋", name:"臭臭鍋", price:100, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"鴨血鍋", name:"鴨血鍋", price:90, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"泡菜鍋", name:"泡菜鍋", price:110, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE.filter(s=>s!=="無辣") },
  { id:"什錦鍋", name:"什錦鍋", price:130, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"腸旺鍋", name:"腸旺鍋", price:130, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"牛雜鍋", name:"牛雜鍋", price:150, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"大腸鴨血鍋", name:"大腸鴨血鍋", price:140, tags:["鍋物"], capacityUnits:1, spice:true, spiceOpts:SPICE },
  { id:"白飯", name:"白飯", price:10, tags:["主食"], capacityUnits:0 },
  { id:"冬粉", name:"冬粉", price:10, tags:["主食"], capacityUnits:0 },
  { id:"科學麵", name:"科學麵", price:15, tags:["主食"], capacityUnits:0 },
  { id:"蟹肉棒", name:"蟹肉棒", price:20, tags:["單點"], capacityUnits:0 },
  { id:"鱈魚丸", name:"鱈魚丸", price:20, tags:["單點"], capacityUnits:0 },
  { id:"北海翅", name:"北海翅", price:20, tags:["單點"], capacityUnits:0 },
  { id:"鑫鑫腸", name:"鑫鑫腸", price:20, tags:["單點"], capacityUnits:0 },
  { id:"高麗菜(冬)", name:"高麗菜(冬)", price:20, tags:["單點"], capacityUnits:0 },
  { id:"金針菇", name:"金針菇", price:10, tags:["單點"], capacityUnits:0 },
  { id:"臭豆腐", name:"臭豆腐", price:20, tags:["單點"], capacityUnits:0 },
  { id:"貢丸", name:"貢丸", price:20, tags:["單點"], capacityUnits:0 },
  { id:"魚餃", name:"魚餃", price:20, tags:["單點"], capacityUnits:0 },
  { id:"燕餃", name:"燕餃", price:20, tags:["單點"], capacityUnits:0 },
  { id:"黑輪", name:"黑輪", price:20, tags:["單點"], capacityUnits:0 },
  { id:"米血", name:"米血", price:20, tags:["單點"], capacityUnits:0 },
  { id:"鴨血", name:"鴨血", price:20, tags:["單點"], capacityUnits:0 },
  { id:"蝦球", name:"蝦球", price:20, tags:["單點"], capacityUnits:0 },
  { id:"大腸", name:"大腸", price:50, tags:["單點"], capacityUnits:0 },
  { id:"豆皮", name:"豆皮", price:30, tags:["單點"], capacityUnits:0 },
];

/* ===== 狀態 & 工具（台北時區版） ===== */
const el = s => document.querySelector(s);
const state = { cart:{}, filter:{keyword:"",tag:""}, ordersCache:[] };

function pad2(n){return n.toString().padStart(2,"0")}
function formatCurrency(n){return " $" + n.toLocaleString("zh-Hant")}
function todayIsoDate(){ return dayjs().tz().format('YYYY-MM-DD'); }
function dateAtTime(dateStr,hh,mm){
  return dayjs.tz(`${dateStr} ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`, 'YYYY-MM-DD HH:mm').toDate();
}
function roundUpToSlot(d, minutes){const ms=minutes*60*1000;return new Date(Math.ceil(d.getTime()/ms)*ms)}
function slotKey(d){return dayjs(d).tz().format('HH:mm')}
function generateSlotsForDate(dateStr){
  const start = dayjs.tz(`${dateStr} ${String(STORE.openHour).padStart(2,'0')}:${String(STORE.openMinute).padStart(2,'0')}`, 'YYYY-MM-DD HH:mm');
  const end   = dayjs.tz(`${dateStr} ${String(STORE.closeHour).padStart(2,'0')}:${String(STORE.closeMinute).padStart(2,'0')}`, 'YYYY-MM-DD HH:mm');
  const arr=[]; for(let t=start.clone(); t.isBefore(end); t=t.add(STORE.slotMinutes,'minute')) arr.push(t.toDate()); return arr;
}
function addDaysIso(dateStr, days){ return dayjs.tz(dateStr,'YYYY-MM-DD').add(days,'day').format('YYYY-MM-DD'); }
function cartTotalQty(){ return Object.values(state.cart).reduce((s,row)=> s + Math.max(0, parseInt(row?.qty||0,10)||0), 0); }

/* ===== 可靠的 fetch 包裝（逾時可控） ===== */
async function fetchWithTimeout(resource, options = {}, timeoutMs = 15000) {
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(resource, { ...options, signal: ctrl.signal });
    return res;
  } catch (err) {
    if (err && err.name === 'AbortError') {
      throw new Error('timeout');
    }
    throw err;
  } finally {
    clearTimeout(timer);
  }
}
async function fetchJson(url, options = {}, timeoutMs = 15000) {
  const res = await fetchWithTimeout(url, options, timeoutMs);
  const txt = await res.text();
  let data;
  try { data = JSON.parse(txt); }
  catch (_) { throw new Error('bad_json'); }
  return data;
}

/* ===== 後端 API ===== */
async function apiList(dateStr){
  const url = new URL(ENDPOINT);
  url.searchParams.set('action','list');
  if (dateStr) url.searchParams.set('date', dateStr);
  url.searchParams.set('key', API_KEY);
  const json = await fetchJson(url.toString(), { method:'GET' }, 15000);
  if (!json.ok) throw new Error(json.error || 'list_failed');
  return json.orders || [];
}

// 重點：把錯誤原文帶出來，方便判讀失敗原因
async function apiCreate(order){
  console.log('creating order payload →', order);
  const res = await fetchWithTimeout(ENDPOINT, {
    method:'POST',
    body: JSON.stringify({ apiKey: API_KEY, action:'create', order })
  }, 20000);
  const txt = await res.text();
  let data;
  try { data = JSON.parse(txt); }
  catch { throw new Error('bad_json:'+txt.slice(0,200)); }
  if (!data.ok) {
    const detail = data.error || 'create_failed';
    const reason = data.reason || data.message || '';
    throw new Error('server:'+detail+(reason?(':'+reason):''));
  }
  return data;
}

/* ===== 訂位計算 ===== */
function bookedCapacityMap(dateStr){
  const map={};
  for(const o of state.ordersCache.filter(o=>o.date===dateStr)){
    const k = slotKey(new Date(o.assignedSlot));
    map[k] = (map[k]||0) + (o.capacityUnits||0);
  }
  return map;
}
function itemsCapacityUnitsFromCart(){
  return Object.values(state.cart).reduce((s,r)=>s+r.item.capacityUnits*r.qty,0);
}
function itemsPriceFromCart(){
  return Object.values(state.cart).reduce((s,r)=>s+r.item.price*r.qty,0);
}
function autoAssignSlot(dateStr, earliest){
  const booked=bookedCapacityMap(dateStr);
  for(const s of generateSlotsForDate(dateStr)){
    if(s.getTime()<earliest.getTime()) continue;
    const used = booked[slotKey(s)] || 0;
    if(used + itemsCapacityUnitsFromCart() <= STORE.slotCapacity) return s;
  }
  return null;
}

/* ===== UI：篩選與菜單 ===== */
function initFilters(){
  const uniq=Array.from(new Set(MENU.flatMap(m=>m.tags))).sort();
  const sel=el("#tagSelect"); uniq.forEach(t=>{const o=document.createElement("option");o.value=t;o.textContent=t;sel.appendChild(o)});
  el("#tagSelect").addEventListener("change",()=>{state.filter.tag=el("#tagSelect").value; renderMenu()});
  el("#searchInput").addEventListener("input",e=>{state.filter.keyword=e.target.value.trim(); renderMenu()});
}
function renderMenu(){
  const root=el("#menuList"); root.innerHTML="";
  const q=state.filter.keyword.toLowerCase(), tag=state.filter.tag;
  const list=MENU.filter(m=>{
    const hitQ=q ? (m.name.toLowerCase().includes(q)) : true;
    const hitT=tag ? m.tags.includes(tag) : true;
    return hitQ && hitT;
  });
  if(!list.length){ root.innerHTML=`<div class="text-slate-600">目前沒有符合的商品。</div>`; return; }

  for(const item of list){
    const card=document.createElement("div"); card.className="card bg-white p-4 flex flex-col";
    const spiceHtml = item.spice
      ? `<label class="text-sm text-slate-600 block mt-2">辣度</label>
         <select class="spice mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
           ${item.spiceOpts.map(s=>`<option value="${s}">${s}</option>`).join("")}
         </select>` : "";

    card.innerHTML=`
      <div class="flex-1">
        <div class="flex items-start justify-between gap-3">
          <h3 class="text-lg font-semibold">${item.name}</h3>
          <div class="text-right font-semibold mono">${formatCurrency(item.price)}</div>
        </div>
        <div class="mt-2 flex flex-wrap gap-1">
          ${item.tags.map(t=>`<span class="badge text-xs px-2 py-1 bg-slate-100 text-slate-700 border border-slate-200">${t}</span>`).join("")}
          ${item.capacityUnits>0?`<span class="badge text-xs px-2 py-1 bg-amber-50 text-amber-700 border border-amber-200">火鍋等效 1</span>`:""}
        </div>
        ${spiceHtml}
      </div>
      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-slate-600">加入購物車數量</div>
        <div class="flex items-center gap-2">
          <button class="dec btn px-3 py-2 border border-slate-300 hover:bg-slate-100">-</button>
          <input type="number" min="1" value="1" class="qty w-16 text-center border border-slate-300 rounded-xl py-2" />
          <button class="inc btn px-3 py-2 border border-slate-300 hover:bg-slate-100">+</button>
          <button class="add btn px-3 py-2 bg-slate-900 text-white hover:bg-slate-800">加入</button>
        </div>
      </div>`;

    const qty=card.querySelector(".qty");
    card.querySelector(".dec").addEventListener("click",()=>{qty.value=Math.max(1,parseInt(qty.value||"1")-1)});
    card.querySelector(".inc").addEventListener("click",()=>{qty.value=Math.max(1,parseInt(qty.value||"1")+1)});
    card.querySelector(".add").addEventListener("click",()=>{
      const chosenSpice = item.spice ? card.querySelector(".spice").value : null;
      addToCart(item, parseInt(qty.value||"1",10), chosenSpice);
    });
    root.appendChild(card);
  }
}

/* ===== 購物車 ===== */
function addToCart(item, qty, spice=null){
  const key = spice ? `${item.id}:${spice}` : item.id;
  const displayName = spice ? `${item.name}（${spice}）` : item.name;
  if(!state.cart[key]) state.cart[key]={ item:{...item, name:displayName}, qty };
  else state.cart[key].qty += qty;
  renderCart();
}
function renderCart(){
  const root=el("#cartItems"); root.innerHTML="";
  const entries=Object.values(state.cart);
  if(!entries.length){ root.innerHTML=`<div class="text-slate-500">購物車目前沒有商品。</div>`; }
  else{
    for(const row of entries){
      const price=row.item.price*row.qty;
      const div=document.createElement("div");
      div.className="flex items-center justify-between gap-3";
      div.innerHTML=`
        <div class="min-w-0">
          <div class="font-medium truncate">${row.item.name}</div>
          <div class="text-sm text-slate-600">
            單價 ${formatCurrency(row.item.price)} ×
            <input type="number" min="1" value="${row.qty}" class="lineQty w-16 text-center border border-slate-300 rounded-lg py-1 mx-1">
            = <span class="mono">${formatCurrency(price)}</span>
          </div>
        </div>
        <button class="remove btn px-3 py-2 border border-slate-300 hover:bg-slate-100">移除</button>`;
      div.querySelector(".lineQty").addEventListener("input",e=>{
        let v = parseInt(e.target.value || "1", 10);
        if (!Number.isFinite(v) || v < 1) v = 1;
        row.qty = v; renderCart();
      });
      div.querySelector(".remove").addEventListener("click",()=>{
        for(const k in state.cart){ if(state.cart[k]===row){ delete state.cart[k]; break; } }
        renderCart();
      });
      root.appendChild(div);
    }
  }
  const subtotal=itemsPriceFromCart();
  const discount=subtotal>=STORE.discountThreshold?STORE.discountAmount:0;
  el("#cartSubtotal").textContent=formatCurrency(subtotal);
  el("#cartDiscount").textContent="-"+formatCurrency(discount).slice(1);
  el("#cartTotal").textContent=formatCurrency(Math.max(0,subtotal-discount));
}

/* ===== 取餐時段（含後援） ===== */
function populateEarliestTimeOptions(){
  const sel=el("#earliestTime");
  const dateStr=todayIsoDate();
  sel.innerHTML = '<option value="">不指定（系統自動安排）</option>';

  let slots = [];
  try { slots = generateSlotsForDate(dateStr); } catch(_){ slots = []; }

  if (Array.isArray(slots) && slots.length) {
    for (const s of slots) {
      const label = slotKey(s);
      const opt=document.createElement("option");
      opt.value=label; opt.textContent=label;
      sel.appendChild(opt);
    }
  } else {
    let h = STORE.openHour, m = STORE.openMinute;
    while (h < STORE.closeHour || (h === STORE.closeHour && m < STORE.closeMinute)) {
      const label = `${pad2(h)}:${pad2(m)}`;
      const opt=document.createElement("option");
      opt.value=label; opt.textContent=label;
      sel.appendChild(opt);
      m += STORE.slotMinutes;
      while (m >= 60) { h += 1; m -= 60; }
    }
  }
  sel.disabled = false;
}

/* ===== 送單（逾時 & 錯誤一定還原按鈕） ===== */
async function onSubmitOrder(e){
  e.preventDefault();
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const setBusy = (b)=>{ submitBtn.disabled = b; submitBtn.textContent = b ? '送出中…' : '送出訂單'; };
  const showErr = (msg)=>{ el("#formError").textContent = msg; };

  setBusy(true);
  el("#formError").textContent = "";

  try{
    if (cartTotalQty() === 0) { showErr("購物車尚無商品。"); return; }
    const name = el("#customerName").value.trim();
    const phone = el("#customerPhone").value.trim();
    if (!name || !phone) { showErr("請完整填寫姓名與電話。"); return; }

    let dateStr = todayIsoDate();
    const openToday  = dayjs.tz(`${dateStr} ${String(STORE.openHour).padStart(2,'0')}:${String(STORE.openMinute).padStart(2,'0')}`, 'YYYY-MM-DD HH:mm');
    const closeToday = dayjs.tz(`${dateStr} ${String(STORE.closeHour).padStart(2,'0')}:${String(STORE.closeMinute).padStart(2,'0')}`, 'YYYY-MM-DD HH:mm');

    const earliestSel = el("#earliestTime").value;
    let earliest;
    if (earliestSel) {
      earliest = dayjs.tz(`${dateStr} ${earliestSel}`, 'YYYY-MM-DD HH:mm');
    } else {
      const candidate = dayjs().tz().add(STORE.prepBufferMinutes, 'minute');
      if (candidate.isBefore(openToday))       earliest = openToday;
      else if (candidate.isAfter(closeToday)) { dateStr = dayjs.tz(dateStr,'YYYY-MM-DD').add(1,'day').format('YYYY-MM-DD'); earliest = dayjs.tz(`${dateStr} ${String(STORE.openHour).padStart(2,'0')}:${String(STORE.openMinute).padStart(2,'0')}`, 'YYYY-MM-DD HH:mm'); }
      else                                     earliest = candidate;
    }
    const rounded = roundUpToSlot(earliest.toDate(), STORE.slotMinutes);

    try{
      state.ordersCache = await apiList(dateStr);
    }catch(_){
      await new Promise(r=>setTimeout(r, 800));
      state.ordersCache = await apiList(dateStr);
    }

    let slot = autoAssignSlot(dateStr, rounded);
    if (!slot) {
      const tmr = dayjs.tz(dateStr,'YYYY-MM-DD').add(1,'day').format('YYYY-MM-DD');
      try { state.ordersCache = await apiList(tmr); } catch(_){}
      const tmrOpen = dateAtTime(tmr, STORE.openHour, STORE.openMinute);
      slot = autoAssignSlot(tmr, tmrOpen);
      if (slot) dateStr = tmr;
    }
    if (!slot) { showErr("近期可用時段已滿，請改天或來電訂餐。"); return; }

    const items = Object.values(state.cart).map(r=>({
      id:r.item.id, name:r.item.name, price:r.item.price, qty:r.qty, capacityUnits:r.item.capacityUnits
    }));
    const capacityUnits = items.reduce((s,it)=>s+it.capacityUnits*it.qty,0);
    const subtotal = items.reduce((s,it)=>s+it.price*it.qty,0);
    const discount = subtotal >= STORE.discountThreshold ? STORE.discountAmount : 0;
    const total = Math.max(0, subtotal - discount);

    const order = {
      id:"O"+Date.now(),
      date: dateStr,
      assignedSlot: slot.toISOString(),
      capacityUnits,
      customer:{ name, phone },
      items, subtotal, discount, total,
      createdAt: new Date().toISOString(),
      source:"web-customer",
    };

    const ret = await apiCreate(order);

    state.cart = {};
    renderCart();
    el("#assignedSlotText").textContent = dayjs(order.assignedSlot).tz().format('YYYY-MM-DD HH:mm');
    el("#successModal").classList.remove("hidden");
  }catch(err){
    console.error('submit_failed', err);
    const m = String(err && err.message || '');

    if (m.includes('empty_order')) {
      showErr('購物車尚無商品，無法送出。');
    } else if (m.includes('timeout')) {
      showErr('連線逾時，請再試一次。');
    } else if (m.startsWith('bad_json')) {
      showErr('伺服器回應格式異常：' + m.slice(8));
    } else if (m.includes('server:unauthorized')) {
      showErr('伺服器拒絕：金鑰或權限不符。請確認 API_KEY 與 Web App 權限（任何擁有連結的人）。');
    } else if (m.startsWith('server:exception')) {
      showErr('伺服器內部錯誤：' + m.replace(/^server:/,''));
    } else {
      showErr('送單失敗：' + m.replace(/^server:/,''));
    }
  }finally{
    setBusy(false);
  }
}

/* ===== 啟動 ===== */
document.addEventListener("DOMContentLoaded", async ()=>{
  initFilters(); renderMenu(); renderCart(); populateEarliestTimeOptions();
  el("#year").textContent=new Date().getFullYear();
  el("#checkoutForm").addEventListener("submit", onSubmitOrder);
  el("#clearCart").addEventListener("click",()=>{state.cart={}; renderCart()});
  el("#closeSuccess").addEventListener("click",()=>el("#successModal").classList.add("hidden"));
  try { state.ordersCache = await apiList(todayIsoDate()); } catch(_){}
});
</script>
</body>
</html>
