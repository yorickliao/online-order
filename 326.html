<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>326臭臭鍋 點餐系統</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark">
  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,0.06); }
    .card { border-radius: 1rem; }
    .btn { border-radius: 1rem; }
    .badge { border-radius: 999px; }
    .container-slim { max-width: 1200px; }
    .mono { font-variant-numeric: tabular-nums; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto container-slim px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-slate-900 text-white rounded-xl grid place-items-center text-lg font-bold select-none">店</div>
        <div>
          <div class="text-xl font-semibold">326臭臭鍋 點餐</div>
          <div class="text-xs text-slate-500">線上點餐・到店自取</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="adminToggle" class="btn px-3 py-2 bg-slate-900 text-white hover:bg-slate-800">今日訂單</button>
        <a href="#cart" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">購物車</a>
      </div>
    </div>
  </header>

  <main class="mx-auto container-slim px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- 左：商品與篩選 -->
    <section class="lg:col-span-2 space-y-6">
      <!-- 搜尋/標籤 -->
      <div class="card bg-white shadow-soft p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="md:col-span-2">
            <label class="text-sm text-slate-600">搜尋商品</label>
            <input id="searchInput" type="text" placeholder="輸入關鍵字"
                   class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900" />
          </div>
          <div>
            <label class="text-sm text-slate-600">標籤</label>
            <select id="tagSelect" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900">
              <option value="">全部</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 商品清單 -->
      <div id="menuList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </section>

    <!-- 右：購物車與結帳 -->
    <aside id="cart" class="space-y-6">
      <div class="card bg-white shadow-soft p-5 sticky top-[88px]">
        <h2 class="text-lg font-semibold mb-4">購物車</h2>
        <div id="cartItems" class="space-y-3"></div>
        <div class="border-t pt-4 mt-4 flex items-center justify-between">
          <div class="text-slate-600">小計</div>
          <div id="cartSubtotal" class="font-semibold mono">$0</div>
        </div>
        <div class="flex items-center justify-between">
          <div class="text-slate-600">預估折扣</div>
          <div id="cartDiscount" class="mono">-$0</div>
        </div>
        <div class="flex items-center justify-between text-lg font-semibold">
          <div>總計</div>
          <div id="cartTotal" class="mono">$0</div>
        </div>
        <button id="clearCart" class="mt-3 w-full btn px-4 py-2 border border-slate-300 hover:bg-slate-100">清空購物車</button>
      </div>

      <div class="card bg-white shadow-soft p-5">
        <h2 class="text-lg font-semibold mb-4">取餐資訊</h2>
        <form id="checkoutForm" class="space-y-4" autocomplete="off">
          <div>
            <label class="text-sm text-slate-600">姓名</label>
            <input required id="customerName" type="text" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900" />
          </div>
          <div>
            <label class="text-sm text-slate-600">電話</label>
            <input required id="customerPhone" type="tel" pattern="[0-9\\-\\+\\s]{8,}" placeholder="09xx-xxx-xxx"
                   class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900" />
          </div>
          <div>
            <label class="text-sm text-slate-600">最早可取餐時間（選填）</label>
            <select id="earliestTime" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900">
              <option value="">不指定（系統自動安排）</option>
            </select>
            <p class="text-xs text-slate-500 mt-1">未選擇時，系統會從「現在時間 + 準備緩衝」開始排。</p>
          </div>
          <div class="bg-slate-50 border border-slate-200 p-3 rounded-xl">
            <div class="text-sm text-slate-700">自動分配規則</div>
            <ul class="list-disc pl-5 text-sm text-slate-600 mt-1">
              <li>每 15 分鐘一個時段。</li>
              <li>每時段上限 7 份「火鍋等效單位」。</li>
              <li>若滿額，會往後順延到下一個可用時段。</li>
            </ul>
          </div>
          <button type="submit" class="w-full btn px-4 py-3 bg-slate-900 text-white hover:bg-slate-800">送出訂單並分配時段</button>
          <p id="formError" class="text-sm text-red-600"></p>
        </form>
      </div>
    </aside>
  </main>

  <!-- 成功彈窗 -->
  <div id="successModal" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 mx-auto mt-24 w-[92%] max-w-xl card bg-white shadow-soft p-6">
      <h3 class="text-xl font-semibold mb-2">下單成功</h3>
      <p class="text-slate-700">您的取餐時段為：</p>
      <p id="assignedSlotText" class="text-2xl font-bold mt-1"></p>
      <p class="text-slate-600 mt-2">也會同時暫存於此瀏覽器的本地訂單清單中（示範用）。</p>
      <div class="mt-4 flex justify-end">
        <button id="closeSuccess" class="btn px-4 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
      </div>
    </div>
  </div>

  <!-- 管理面板 -->
  <div id="adminPanel" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 mx-auto mt-16 w-[96%] max-w-5xl card bg-white shadow-soft p-6">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">今日訂單 / 時段概況</h3>
        <div class="flex items-center gap-2">
          <button id="exportCsv" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">匯出 CSV</button>
          <button id="closeAdmin" class="btn px-3 py-2 bg-slate-900 text-white hover:bg-slate-800">關閉</button>
        </div>
      </div>
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h4 class="font-medium mb-2">各時段累計（火鍋等效）</h4>
          <div id="slotSummary" class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm"></div>
        </div>
        <div class="overflow-auto">
          <h4 class="font-medium mb-2">今日訂單列表</h4>
          <table class="w-full text-sm border border-slate-200">
            <thead class="bg-slate-50">
              <tr>
                <th class="p-2 border-b text-left">時間</th>
                <th class="p-2 border-b text-left">姓名</th>
                <th class="p-2 border-b text-left">電話</th>
                <th class="p-2 border-b text-left">品項</th>
                <th class="p-2 border-b text-right">等效</th>
                <th class="p-2 border-b text-right">金額</th>
              </tr>
            </thead>
            <tbody id="adminOrders"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <footer class="border-t border-slate-200 mt-12">
    <div class="mx-auto container-slim px-4 py-6 text-sm text-slate-600">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>營業時間：每日 16:30–20:30（可於程式常數設定）</div>
        <div>© <span id="year"></span> 326臭臭鍋</div>
      </div>
    </div>
  </footer>

  <script>
    // =========================
    // 基本設定（可依店家調整）
    // =========================
    const STORE = {
      name: "326臭臭鍋",
      openHour: 16,       // 開店小時（0-23）：16=下午4點
      openMinute: 30,     // 開店分鐘
      closeHour: 20,      // 打烊小時：20=晚上8點
      closeMinute: 30,    // 打烊分鐘
      slotMinutes: 15,
      slotCapacity: 7,    // 每時段「火鍋等效」上限：7
      prepBufferMinutes: 20, // 未指定時間時，現在 + 緩衝
      discountThreshold: 1500, // 折扣門檻（示例）
      discountAmount: 100,     // 折扣金額（示例）
    };

    // 商品清單：capacityUnits 表示「火鍋等效單位」
    const MENU = [
      { id: "hp_classic", name: "招牌麻辣鍋", price: 280, desc: "經典麻辣湯底（小辣）", tags: ["鍋物","辣"], capacityUnits: 1 },
      { id: "hp_mushroom", name: "養生菇菇鍋", price: 260, desc: "清爽菇菇湯底", tags: ["鍋物","素"], capacityUnits: 1 },
      { id: "hp_tomato", name: "番茄牛肉鍋", price: 300, desc: "酸香番茄與牛肉片", tags: ["鍋物"], capacityUnits: 1 },
      { id: "side_platter", name: "綜合拼盤", price: 150, desc: "時蔬/豆腐/菇類拼盤", tags: ["加點"], capacityUnits: 0 },
      { id: "rice", name: "白飯", price: 20, desc: "熱白飯", tags: ["主食"], capacityUnits: 0 },
      { id: "drink", name: "冬瓜檸檬", price: 45, desc: "清爽解膩", tags: ["飲品"], capacityUnits: 0 },
    ];

    // =========================
    // 狀態 / 儲存
    // =========================
    const el = sel => document.querySelector(sel);
    const els = sel => Array.from(document.querySelectorAll(sel));

    const state = {
      cart: {}, // { [id]: { item, qty } }
      orders: loadOrders(), // localStorage 模擬
      filter: { keyword: "", tag: "" },
    };

    function saveOrders() {
      localStorage.setItem("orders_v1", JSON.stringify(state.orders));
    }
    function loadOrders() {
      try {
        return JSON.parse(localStorage.getItem("orders_v1")) || [];
      } catch { return []; }
    }

    // =========================
    // 工具：時間與時段
    // =========================
    function pad2(n) { return n.toString().padStart(2,"0"); }
    function formatCurrency(n) { return " $" + n.toLocaleString("zh-Hant"); }

    function todayIsoDate() {
      const d = new Date();
      const y = d.getFullYear(), m = d.getMonth()+1, day = d.getDate();
      return `${y}-${pad2(m)}-${pad2(day)}`;
    }

    function roundUpToSlot(d, slotMinutes) {
      const ms = slotMinutes * 60 * 1000;
      return new Date(Math.ceil(d.getTime() / ms) * ms);
    }

    function dateAtTime(dateStr, hh, mm) {
      const d = new Date(dateStr + "T00:00:00");
      d.setHours(hh, mm, 0, 0);
      return d;
    }

    function generateSlotsForDate(dateStr) {
      const slots = [];
      const start = dateAtTime(dateStr, STORE.openHour, STORE.openMinute || 0);
      const end = dateAtTime(dateStr, STORE.closeHour, STORE.closeMinute || 0);
      const stepMs = STORE.slotMinutes * 60 * 1000;
      for (let t = start.getTime(); t < end.getTime(); t += stepMs) {
        slots.push(new Date(t));
      }
      return slots;
    }

    function slotKey(d) {
      // 同一天的 HH:mm 作為 key
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function sumCapacityUnits(order) {
      return order.items.reduce((s, it) => s + (it.capacityUnits * it.qty), 0);
    }

    function itemsCapacityUnitsFromCart() {
      return Object.values(state.cart).reduce((s, row) => s + row.item.capacityUnits * row.qty, 0);
    }

    function itemsPriceFromCart() {
      return Object.values(state.cart).reduce((s, row) => s + row.item.price * row.qty, 0);
    }

    // 計算今日各時段已被預訂的等效數
    function bookedCapacityMap(dateStr) {
      const map = {}; // { "HH:mm": count }
      const dayOrders = state.orders.filter(o => o.date === dateStr);
      for (const o of dayOrders) {
        const k = slotKey(new Date(o.assignedSlot));
        map[k] = (map[k] || 0) + o.capacityUnits;
      }
      return map;
    }

    // 自動分配時段（最早可取餐時間 -> 找第一個未滿的 slot）
    function autoAssignSlot(dateStr, earliest) {
      const slots = generateSlotsForDate(dateStr);
      const booked = bookedCapacityMap(dateStr);
      for (const s of slots) {
        if (s.getTime() < earliest.getTime()) continue;
        const k = slotKey(s);
        const used = booked[k] || 0;
        if (used + itemsCapacityUnitsFromCart() <= STORE.slotCapacity) {
          return s;
        }
      }
      return null; // 今日無可用
    }

    // =========================
    // 商品與購物車 UI
    // =========================
    function initFilters() {
      const uniqTags = Array.from(new Set(MENU.flatMap(m => m.tags))).sort();
      const sel = el("#tagSelect");
      for (const t of uniqTags) {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      }
      sel.addEventListener("change", () => {
        state.filter.tag = sel.value;
        renderMenu();
      });
      el("#searchInput").addEventListener("input", (e) => {
        state.filter.keyword = e.target.value.trim();
        renderMenu();
      });
    }

    function renderMenu() {
      const root = el("#menuList");
      root.innerHTML = "";
      const q = state.filter.keyword.toLowerCase();
      const tag = state.filter.tag;
      const list = MENU.filter(m => {
        const hitQ = q ? (m.name.toLowerCase().includes(q) || m.desc.toLowerCase().includes(q)) : true;
        const hitT = tag ? m.tags.includes(tag) : true;
        return hitQ && hitT;
      });

      if (!list.length) {
        root.innerHTML = `<div class="text-slate-600">找不到符合關鍵字/標籤的商品。</div>`;
        return;
      }

      for (const item of list) {
        const card = document.createElement("div");
        card.className = "card bg-white shadow-soft p-4 flex flex-col";
        card.innerHTML = `
          <div class="flex-1">
            <div class="flex items-start justify-between gap-3">
              <h3 class="text-lg font-semibold">${item.name}</h3>
              <div class="text-right font-semibold mono">${formatCurrency(item.price)}</div>
            </div>
            <p class="text-slate-600 mt-1">${item.desc}</p>
            <div class="mt-2 flex flex-wrap gap-1">
              ${item.tags.map(t => `<span class="badge text-xs px-2 py-1 bg-slate-100 text-slate-700 border border-slate-200">${t}</span>`).join("")}
              ${item.capacityUnits>0 ? `<span class="badge text-xs px-2 py-1 bg-amber-50 text-amber-700 border border-amber-200">火鍋等效 ${item.capacityUnits}</span>` : ""}
            </div>
          </div>
          <div class="mt-4 flex items-center justify-between">
            <div class="text-sm text-slate-600">加入購物車數量</div>
            <div class="flex items-center gap-2">
              <button class="dec btn px-3 py-2 border border-slate-300 hover:bg-slate-100">-</button>
              <input type="number" min="1" value="1" class="qty w-16 text-center border border-slate-300 rounded-xl py-2" />
              <button class="inc btn px-3 py-2 border border-slate-300 hover:bg-slate-100">+</button>
              <button class="add btn px-3 py-2 bg-slate-900 text-white hover:bg-slate-800">加入</button>
            </div>
          </div>
        `;
        const qtyInput = card.querySelector(".qty");
        card.querySelector(".dec").addEventListener("click", () => {
          const v = Math.max(1, parseInt(qtyInput.value||"1",10)-1);
          qtyInput.value = v;
        });
        card.querySelector(".inc").addEventListener("click", () => {
          const v = Math.max(1, parseInt(qtyInput.value||"1",10)+1);
          qtyInput.value = v;
        });
        card.querySelector(".add").addEventListener("click", () => {
          addToCart(item, parseInt(qtyInput.value||"1",10));
        });
        root.appendChild(card);
      }
    }

    function addToCart(item, qty) {
      if (!state.cart[item.id]) {
        state.cart[item.id] = { item, qty };
      } else {
        state.cart[item.id].qty += qty;
      }
      renderCart();
    }

    function renderCart() {
      const root = el("#cartItems");
      root.innerHTML = "";
      const entries = Object.values(state.cart);
      if (!entries.length) {
        root.innerHTML = `<div class="text-slate-500">購物車目前沒有商品。</div>`;
      } else {
        for (const row of entries) {
          const div = document.createElement("div");
          div.className = "flex items-center justify-between gap-3";
          const price = row.item.price * row.qty;
          div.innerHTML = `
            <div class="min-w-0">
              <div class="font-medium truncate">${row.item.name}</div>
              <div class="text-sm text-slate-600">
                單價 ${formatCurrency(row.item.price)} ×
                <input type="number" min="1" value="${row.qty}" class="lineQty w-16 text-center border border-slate-300 rounded-lg py-1 mx-1">
                = <span class="mono">${formatCurrency(price)}</span>
              </div>
            </div>
            <button class="remove btn px-3 py-2 border border-slate-300 hover:bg-slate-100">移除</button>
          `;
          div.querySelector(".lineQty").addEventListener("input", (e) => {
            const v = Math.max(1, parseInt(e.target.value||"1",10));
            row.qty = v;
            renderCart();
          });
          div.querySelector(".remove").addEventListener("click", () => {
            delete state.cart[row.item.id];
            renderCart();
          });
          root.appendChild(div);
        }
      }

      const subtotal = itemsPriceFromCart();
      const discount = subtotal >= STORE.discountThreshold ? STORE.discountAmount : 0;
      const total = Math.max(0, subtotal - discount);
      el("#cartSubtotal").textContent = formatCurrency(subtotal);
      el("#cartDiscount").textContent = "-" + formatCurrency(discount).slice(1);
      el("#cartTotal").textContent = formatCurrency(total);
    }

    // =========================
    // 結帳 / 下單
    // =========================
    function onSubmitOrder(e) {
      e.preventDefault();
      el("#formError").textContent = "";

      if (!Object.values(state.cart).length) {
        el("#formError").textContent = "購物車尚無商品。";
        return;
      }
      const name = el("#customerName").value.trim();
      const phone = el("#customerPhone").value.trim();
      if (!name || !phone) {
        el("#formError").textContent = "請完整填寫姓名與電話。";
        return;
      }

      const dateStr = todayIsoDate();
      const now = new Date();
      const earliestInput = el("#earliestTime").value;
      let earliest = earliestInput
        ? dateAtTime(dateStr, parseInt(earliestInput.slice(0,2),10), parseInt(earliestInput.slice(3),10))
        : new Date(now.getTime() + STORE.prepBufferMinutes * 60 * 1000);

      // 四捨五入至下一個 15 分鐘時段
      earliest = roundUpToSlot(earliest, STORE.slotMinutes);

      // 若早於開店，從開店後第一格開始
      const openAt = dateAtTime(dateStr, STORE.openHour, STORE.openMinute || 0);
      if (earliest.getTime() < openAt.getTime()) earliest = openAt;

      // 自動分配
      const slot = autoAssignSlot(dateStr, earliest);
      if (!slot) {
        el("#formError").textContent = "今日可用時段已滿，請改天或稍後再試。";
        return;
      }

      // 建立訂單物件
      const items = Object.values(state.cart).map(r => ({
        id: r.item.id, name: r.item.name, price: r.item.price,
        qty: r.qty, capacityUnits: r.item.capacityUnits
      }));
      const capacityUnits = items.reduce((s, it) => s + it.capacityUnits * it.qty, 0);
      const subtotal = items.reduce((s, it) => s + it.price * it.qty, 0);
      const discount = subtotal >= STORE.discountThreshold ? STORE.discountAmount : 0;
      const total = Math.max(0, subtotal - discount);

      const order = {
        id: "O" + Date.now(),
        date: dateStr,
        assignedSlot: slot.toISOString(),
        capacityUnits,
        customer: { name, phone },
        items, subtotal, discount, total,
        createdAt: new Date().toISOString(),
        source: "web-demo-local",
      };

      // TODO: 在此呼叫後端 API / Google Apps Script / n8n Webhook
      // fetch("YOUR_ENDPOINT", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(order) })

      // 本地暫存
      state.orders.push(order);
      saveOrders();

      // 清空購物車
      state.cart = {};
      renderCart();

      // 顯示成功
      el("#assignedSlotText").textContent = `${order.date} ${slotKey(new Date(order.assignedSlot))}`;
      el("#successModal").classList.remove("hidden");
    }

    // =========================
    // 管理面板（本地）
    // =========================
    function renderAdmin() {
      const dateStr = todayIsoDate();
      const slots = generateSlotsForDate(dateStr);
      const booked = bookedCapacityMap(dateStr);

      // 時段 summary
      const sumRoot = el("#slotSummary");
      sumRoot.innerHTML = "";
      for (const s of slots) {
        const k = slotKey(s);
        const used = booked[k] || 0;
        const div = document.createElement("div");
        div.className = "border border-slate-200 rounded-xl p-2";
        div.innerHTML = `
          <div class="text-xs text-slate-600">${k}</div>
          <div class="font-semibold mono">${used} / ${STORE.slotCapacity}</div>
          <div class="h-2 bg-slate-100 rounded mt-1">
            <div class="h-2 bg-slate-900 rounded" style="width:${Math.min(100, used/STORE.slotCapacity*100)}%"></div>
          </div>
        `;
        sumRoot.appendChild(div);
      }

      // 訂單表
      const tbody = el("#adminOrders");
      tbody.innerHTML = "";
      const todayOrders = state.orders
        .filter(o => o.date === dateStr)
        .sort((a,b) => new Date(a.assignedSlot)-new Date(b.assignedSlot));
      for (const o of todayOrders) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2 border-b">${slotKey(new Date(o.assignedSlot))}</td>
          <td class="p-2 border-b">${o.customer.name}</td>
          <td class="p-2 border-b">${o.customer.phone}</td>
          <td class="p-2 border-b">
            ${o.items.map(it => `${it.name}×${it.qty}`).join("，")}
          </td>
          <td class="p-2 border-b text-right mono">${o.capacityUnits}</td>
          <td class="p-2 border-b text-right mono">${formatCurrency(o.total)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function exportTodayCsv() {
      const dateStr = todayIsoDate();
      const rows = [
        ["訂單ID","日期","時段","姓名","電話","品項","火鍋等效","小計","折扣","總計","建立時間"]
      ];
      const list = state.orders.filter(o => o.date === dateStr);
      for (const o of list) {
        rows.push([
          o.id,
          o.date,
          slotKey(new Date(o.assignedSlot)),
          o.customer.name,
          o.customer.phone,
          o.items.map(it=>`${it.name}×${it.qty}`).join(" / "),
          o.capacityUnits,
          o.subtotal,
          o.discount,
          o.total,
          o.createdAt
        ]);
      }
      const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `orders_${dateStr}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // =========================
    // 選單生成：最早可取餐時間（16:30–20:30，每 15 分鐘）
    // =========================
    function populateEarliestTimeOptions() {
      const dateStr = todayIsoDate();
      const sel = el("#earliestTime");
      const slots = generateSlotsForDate(dateStr); // 已依營業時間與粒度生成
      for (const s of slots) {
        const label = slotKey(s); // HH:mm
        const opt = document.createElement("option");
        opt.value = label;
        opt.textContent = label;
        sel.appendChild(opt);
      }
    }

    // =========================
    // 初始綁定
    // =========================
    function init() {
      initFilters();
      renderMenu();
      renderCart();
      el("#year").textContent = new Date().getFullYear();
      populateEarliestTimeOptions();

      el("#checkoutForm").addEventListener("submit", onSubmitOrder);
      el("#clearCart").addEventListener("click", () => {
        state.cart = {};
        renderCart();
      });

      // 成功面板
      el("#closeSuccess").addEventListener("click", () => {
        el("#successModal").classList.add("hidden");
      });

      // 管理面板
      el("#adminToggle").addEventListener("click", () => {
        renderAdmin();
        el("#adminPanel").classList.remove("hidden");
      });
      el("#closeAdmin").addEventListener("click", () => {
        el("#adminPanel").classList.add("hidden");
      });
      el("#exportCsv").addEventListener("click", exportTodayCsv);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
